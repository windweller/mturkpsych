<html>
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<head>
  <title>3D-Wordiverse</title>

  <style>

    #minimize {
        float: left;
    }
    body {font: 10pt arial;}
    #visibleWhenClicked {
        visibility: hidden;
    }

    .Fixed
    {
        position: fixed;
        bottom: 30px;
        left: 0px;
        right: 0px;
        border: dotted;
        border-width: thin;
        background-color:  #C3D9E0;
        padding: 20px;
        width: 90%;
        opacity: 0.8;
        margin: 0 auto;
        visibility: hidden;
    }
    .Fixed2
    {
        position: fixed;
        top: 40px;
        left: 0px;
        right: 0px;
        border: dotted;
        border-width: thin;
        background-color:  #C3D9E0;
        padding: 10px;
        width: 100%;
        opacity: 0.8;
        margin: 0 auto;
        visibility: hidden;
    }
    .Fixed3
    {
        position: fixed;
        top: 56px;
        left: 13px;
        right: 0px;
        opacity: 0.8;
        margin: 0 auto;
        visibility: hidden;
    }
    textarea {
        resize: none;
    };
  </style>

  <link href="css/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="css/vendor/slider.css">
  <link rel="stylesheet" type="text/css" href="css/mystyle.css">

  <script>
    var idCounter = 0;
    /** DETECTING BROWSER **/
    var isOpera = !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
    // Opera 8.0+ (UA detection to detect Blink/v8-powered Opera)
    var isFirefox = typeof InstallTrigger !== 'undefined';   // Firefox 1.0+
    var isSafari = Object.prototype.toString.call(window.HTMLElement).indexOf('Constructor') > 0;
    // At least Safari 3+: "[object HTMLElementConstructor]"
    var isChrome = !!window.chrome && !isOpera;              // Chrome 1+
    var isIE = /*@cc_on!@*/false || !!document.documentMode;   // At least IE6
    /** DETECTING BROWSER ENDS**/
  </script>

  <script type="text/javascript" src="js/vendor/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="js/vendor/vis.js"></script>
  <script type="text/javascript" src="js/vendor/bootstrapslider.js"></script>


</head>

<body>
    <div class="ok">

        <div class = "container">
            <div class="menu">
                 <ul class="nav navbar-nav">
                   <li><a href="future">Home</a></li>
                   <li><a href="futureAnalysis">Demo</a></li>
                   <li><a href="realTimeGraph">Statistical graph</a></li>
                   <li><a href="trainingCorpus">Training Corpus</a></li>
                   <li><a href="sourceCode">Source Code</a></li>
                   <li><a href="wordiverse5">Wordiverse</a></li>
                   <li><a href="3dwordiverse">3D-Wordiverse</a></li>

                 </ul>
            </div>

            <div id = "top-layer" class="container-fluid">
                <br/><br/>
                <hr/>
                <br/>
                <h1 style="display: inline;">3D - Wordiverse</h1>

            </div>
            <br/> <br/>

            <div class="jumbotron col-md-16 center">
            <input type="file" id="files" name="files[]" multiple />
            <output id="list"></output>
            </div>

            <button type="button" id="find" class="btn btn-primary" style="width:120px; height:45px;">Display</button>
            <hr>
            <div id = "visibleWhenClicked" class="jumbotron col-md-16 center">

            <h5 align = "center">Hover/Click each individual point to see detail</h5>

            <div align = "center">
                <hr>
                Use below to shift center of X, Y, Z <br>
                (Or use keyboard q,w,a,s,z,x, each corresponding to x+,x-,y+,y-,z+,z-)<br>
            <button type="button" id="xplus" class="btn btn-primary" style="width:60px; height:45px;">x+</button>
            <button type="button" id="xminus" class="btn btn-primary" style="width:60px; height:45px;">x-</button>
            <button type="button" id="yplus" class="btn btn-primary" style="width:60px; height:45px;">y+</button>
            <button type="button" id="yminus" class="btn btn-primary" style="width:60px; height:45px;">y-</button>
            <button type="button" id="zplus" class="btn btn-primary" style="width:60px; height:45px;">z+</button>
            <button type="button" id="zminus" class="btn btn-primary" style="width:60px; height:45px;">z-</button>
            <button type="button" id="restoreCenter" class="btn btn-primary" style="width:120px; height:45px;">Restore</button>
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <button type="button" id="download" class="btn btn-primary" style="width:150px; height:45px;">DOWNLOAD CSV</button>
            </div>
            </div>
            <div id="mygraph">
                <div style="position: relative; overflow: hidden; width: 600px; height: 600px;">
                    <canvas width="600" height="600" style="position: relative; width: 100%; height: 100%;">
                        <div style="color: red; font-weight: bold; padding: 10px;">Error: your browser does not support HTML canvas</div>
                    </canvas>
                <div style="position: absolute; bottom: 0px; left: 0px; width: 580px;">

                </div>
                </div>
            </div>

            <div class = "container fixed" id = "new">
                <div align = "center" >
                    Label: <textarea id = "hover1" resize= none; rows="1" cols="10"></textarea> &nbsp
                    Xcoord: <textarea id = "hover2"  resize= none; rows="1" cols="10"></textarea> &nbsp
                    Ycoord: <textarea id = "hover3"  resize= none; rows="1" cols="10"></textarea> &nbsp
                    Zcoord: <textarea id = "hover4"  resize= none; rows="1" cols="10"></textarea> &nbsp
                    <button align = "right" type="button" id="newLabelQuick" class="btn btn-primary" style="width:100px; height:45px;">Quick New</button>
                    <button align = "right" type="button" id="newLabel" class="btn btn-primary" style="width:100px; height:45px;">Create New</button>
                    <button align = "right" type="button" id="newLabelEdit" class="btn btn-primary" style="width:80px; height:45px;">Update</button>
                    <button align = "right" type="button" id="newLabelDelete" class="btn btn-primary" style="width:60x; height:45px;">Delete</button>
                    <button align = "right" type="button" id="newLabelClose" class="btn btn-primary" style="width:40px; height:45px;">X</button>


                </div>
            </div>

            <div class = "fixed2" id = "topMenu">
                <div align = "center">
                    <h4 align = "center">
                        <button align = "right" type="button" id="minimize" class="btn btn-primary" style="width:100px; height:30px;">MINIMIZE</button>
                    </h4>
                    <h4 align = "center">
                        Adjust the SIZE of the POINT: <input type="text" id="foo" class="span2" value="" data-slider-min="10" data-slider-max="1000" data-slider-step="1" data-slider-value="1" data-slider-orientation="horizontal" data-slider-selection="after"data-slider-tooltip="hide">&nbsp&nbsp&nbsp
                        Adjust the SIZE of the LABEL: <input type="text" id="foo1" class="span2" value="" data-slider-min="1" data-slider-max="30" data-slider-step="1" data-slider-value="1" data-slider-orientation="horizontal" data-slider-selection="after"data-slider-tooltip="hide">&nbsp&nbsp&nbsp
                        <label class="checkbox-inline"><input id = "textCheck" type="checkbox" value="">SHOW TEXT LABEL</label>
                    </h4>


                </div>
            </div>
            <div class = "fixed3" id = "topIcon">
                <button align = "right" type="button" id="minimize2" class="btn btn-primary" style="width:40px; height:30px;">+</button>
            </div>




            <div id="footer">
                  <div class="container">
              <hr/>
              <a href="http://www.emory.edu"><img src="img/university2.png" alt="Emory" width="60"/></a>
              <a href="http://www.sfl.cnrs.fr"><img src="img/sfl.jpg" alt="SFL" width="130"/></a>
              <a href="http://www.cnrs.fr"><img src="img/cnrs.jpg" alt="CNRS" /></a>
              <a href="http://www.univ-paris8.fr "><img src="img/P8.jpg" alt="Paris 8 University" width="120" /></a>
            </div></div>

            <div id="info"></div>
    </div>
</div>
<script>
var data_txt;
var dataContent;
var labels = [];
var categories = [];
$("#minimize").click(function() {
        document.getElementById("topMenu").style.visibility= "hidden" ;
        document.getElementById("topIcon").style.visibility= "visible" ;
});
$("#minimize2").click(function() {
        document.getElementById("topMenu").style.visibility= "visible" ;
        document.getElementById("topIcon").style.visibility= "hidden" ;
});


 $('#files').click(function() {
     //RESET
     data_txt = null;
     dataContent = null;
     labels = [];
     categories = [];
     isThereLimitOnCameraRotation = false;
     canZoomInfinite = true;
     dotSizeFromUser = 0.001;
     if($('#textCheck').prop("checked") == true) {
         enableDrawText = true;
     } else {
         enableDrawText = false;
     }
 }

 );
  function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    data_txt = "";
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');

      var reader = new FileReader();
      reader.onload = function(e) {
          data_txt += reader.result + "\n";
      }
      reader.readAsText(f);
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }
  document.getElementById('files').addEventListener('change', handleFileSelect);


  $("#find").click(function() {
      //RESET data


      var d = ",";
      var lines = data_txt.split("\n");
      var raw_data = [];
      for(var i=1;i<lines.length;i++) {
        var row = lines[i];
        if (! /\S/.test(row)) {
          // row is empty and only has whitespace
          continue;
        }
        var cells = row.split(d);
        var data_point = [];
        labels.push(cells[0]);
        categories.push(cells[1]);
        for(var j=2;j<cells.length;j++) {
          if(cells[j].length !== 0) {
            data_point.push(parseFloat(cells[j]));
          }
        }

        raw_data.push(data_point);
      }
      dataContent = raw_data; // set global

      drawVisualization(1000/100000.0);
      document.getElementById("visibleWhenClicked").style.visibility= "visible" ;
      document.getElementById("topMenu").style.visibility= "hidden" ;
      document.getElementById("topIcon").style.visibility= "hidden" ;
      document.getElementById("new").style.visibility= "hidden" ;
      document.getElementById("topMenu").style.visibility= "visible" ;



      $('html, body').animate({
          scrollTop: $("#mygraph").offset().top
      }, 1200);
  });

</script>

<script type="text/javascript">
  var data = null;
  var graph = null;


  // Called when the Visualization API is loaded.
  function drawVisualization(inputDotSize) {
    // create the data table.
    data = new vis.DataSet();
    // create some shortcuts to math functions
    var sqrt = Math.sqrt;
    var pow = Math.pow;
    var random = Math.random;

    // create the animation data
    for (var i = 0; i < dataContent.length; i++) {
      var x = dataContent[i][0];
      var y = dataContent[i][1];
      var z = dataContent[i][2];
      var dist = categories[i]/10;
      var vocabulary = labels[i];

      data.add({id: idCounter, x:x,y:y,z:z, style:dist, word:vocabulary, color: dist});
      idCounter = idCounter + 1;
    }
    // specify options
    var options = {
      width:  '1000px',
      height: '1000px',
      style: 'dot-color',
      showPerspective: false,
      cameraPosition: {horizontal: -1.0, vertical: -10.5, distance: 1.7},
      showGrid: false,
      keepAspectRatio: true,
      verticalRatio: 1,
      legendLabel: 'category',
      xValueLabel: function (x) {return ""},
      yValueLabel: function (y) {return ""},
      zValueLabel: function (z) {return ""},
      tooltip: function(point) {

          return "TOOLTIP";
      },
      cameraPosition: {
        horizontal: -0.35,
        vertical: 0.22,
        distance: 1.8
      }
    };

    // create our graph
    var container = document.getElementById('mygraph');
    graph = new vis.Graph3d(container, data, options, inputDotSize);
  }

  $('#foo').slider("setValue", 1000)
    .on('slide', function(ev){

       $('#bar').val(ev.value/100000.0);
       dotSizeFromUser = ev.value/100000.0;
       graph.redraw();
    });

    $('#foo1').slider("setValue", 15)
      .on('slide', function(ev){

         $('#bar').val(ev.value);
         fontSizeFromUser = ev.value+"px Arial";
         graph.redraw();
      });

    $('#textCheck').change( function() {
        if(enableDrawText == true)
            enableDrawText = false;
        else
            enableDrawText = true;

        graph.redraw();
    }
    );
    var shiftBy = 0.005
    function redrawScale () {
        graph._setScale();
        graph.redraw();
    }
    $("#xplus").click(function() {
        shiftX = shiftX + shiftBy;
        redrawScale();
    });
    $("#xminus").click(function() {
        shiftX = shiftX - shiftBy
        redrawScale();

    });
    $("#yplus").click(function() {
        shiftY = shiftY + shiftBy;
        redrawScale();

    });
    $("#yminus").click(function() {
        shiftY = shiftY - shiftBy;
        redrawScale();


    });
    $("#zplus").click(function() {
        shiftZ = shiftZ + shiftBy;
        redrawScale();


    });
    $("#zminus").click(function() {
        shiftZ = shiftZ - shiftBy;
        redrawScale();

    });
    $("#restoreCenter").click(function() {
        shiftX = 0;
        shiftY = 0;
        shiftZ = 0;
        redrawScale();

    });

    document.addEventListener('keydown', function(event) {
        if (event.keyCode == 81) {
            shiftX = shiftX - shiftBy
            redrawScale();
        }
        else if (event.keyCode == 87) {
            shiftX = shiftX + shiftBy
            redrawScale();
        }
        else if (event.keyCode == 65) {
            shiftY = shiftY - shiftBy
            redrawScale();
        }
        else if (event.keyCode == 83) {
            shiftY = shiftY + shiftBy
            redrawScale();
        }
        else if (event.keyCode == 90) {
            shiftZ = shiftZ - shiftBy
            redrawScale();
        }
        else if (event.keyCode == 88) {
            shiftZ = shiftZ + shiftBy
            redrawScale();
        } }, true);

    $("#newLabelQuick").click(function() {
        var word = $("#hover1").val();
        word = word + "*"
        var x1 = $("#hover2").val();
        var y1 = $("#hover3").val();
        var z1 = $("#hover4").val();
        x1 = Number(x1)+0.5;
        y1 = Number(y1)+0.5;
        z1 = Number(z1)+0.5;

        data.add({id: idCounter, x:x1,y:y1,z:z1, style:null, word:word, color: null});
        idCounter = idCounter + 1;
        graph.redraw();
    });
    $("#newLabel").click(function() {
        var word = $("#hover1").val();

        var x1 = Number($("#hover2").val());
        var y1 = Number($("#hover3").val());
        var z1 = Number($("#hover4").val());

        //search if already exist
        var i;
        var tempData;
        var ids = data.getIds();
        for(i = 0; i < ids.length; i++) {
            tempData = data.get(ids[i]);
            if ((tempData.x == x1) && (tempData.y == y1) && (tempData.z == z1)) {
                var r = confirm("A word ''" + word + "' with same vector exists. Are you sure you want to continue?");
                if (r) {
                    data.add({id: idCounter, x:x1,y:y1,z:z1, style:null, word:word, color: null});
                    graph.redraw
                    alert("Point Inserted");
                } else {
                    alert("Stopped");
                }
            }
        }

    });
    $("#newLabelClose").click(function() {
        document.getElementById("new").style.visibility= "hidden" ;
    });
    $("#newLabelEdit").click(function() {
        alert("NOT YET SUPPORTED. I'M WORKING ON IT!");
    });
    $("#newLabelDelete").click(function() {
        var i;
        var word = $("#hover1").val();
        var x1 = Number($("#hover2").val());
        var y1 = Number($("#hover3").val());
        var z1 = Number($("#hover4").val());
        var tempData;
        var ids = data.getIds();
        console.log(ids);
        for(i = 0; i < ids.length; i++) {
            tempData = data.get(ids[i]);
            console.log(tempData);
            if ((tempData.x == x1) && (tempData.y == y1) && (tempData.z == z1) && (tempData.word == word)) {
                data.remove(tempData.id);
                console.log("found item to delete");
            }
        }
        graph.redraw();
    });

    //click to initiate floating bottom menu
    var $body = $('#mygraph');
    $body.on('mousedown', function (evt) {
      $body.on('mouseup mousemove', function handler(evt) {
        if (evt.type === 'mouseup') {
            document.getElementById("new").style.visibility= "visible" ;
            console.log("n clicked");
            console.log("X: " + mousePosition.x + "Y: " + mousePosition.y);
            var dataPoint2 = graph._dataPointFromXY(mousePosition.x, mousePosition.y);
            console.log("The DataPoint: " +dataPoint2.point.word + " " +  dataPoint2.point.x + " " + dataPoint2.point.y + " " + dataPoint2.point.color);
            $("#hover1").val(dataPoint2.point.word);
            $("#hover2").val(dataPoint2.point.x);
            $("#hover3").val(dataPoint2.point.y);
            $("#hover4").val(dataPoint2.point.z);
        } else {
          //console.log("drag");
        }
        $body.off('mouseup mousemove', handler);
      });
    });

    //CSV Download
    $("#download").click(function() {
        var theBigArray = [];
        var tempData;
        var ids = data.getIds();
        for(i = 0; i < ids.length; i++) {
            var object = {};
            tempData = data.get(ids[i]);
            console.log(tempData);
            object.verb = tempData.word;
            object.cluster = tempData.color;
            object.x = tempData.x;
            object.y = tempData.y;
            object.z = tempData.z;
            console.log("OBJECT: " + object);
            theBigArray.push(object);
        }
        console.log("THE BIG ARRAY: " + theBigArray);

        if(theBigArray.length == 0){
            alert("EMPTY");
        } else {
            //Json Conversion for Download Starts
            var downloadable = theBigArray;
            //Json Conversion Ends
            var csv = JSON2CSV(theBigArray);
            console.log(theBigArray);

            if(isIE) {
                //window.open("data:text/csv;charset=utf-8," + escape(csv) + ".csv", "table.csv");
                var CSV = csv;
                var IEwindow = window.open();
                IEwindow.document.write('sep=,\r\n' + CSV);
                IEwindow.document.close();
                IEwindow.document.execCommand('SaveAs', true,  "table.csv");
                IEwindow.close();
            } else {
                var link = document.createElement('a');
                link.download = "table.csv";
                link.href = "data:text/csv;charset=utf-8," + escape(csv);

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    });
    function JSON2CSV(objArray) {
        var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
        var str = '';
        var line = '';
        var head = array[0];
        for (var index in array[0]) {
            var value = index + "";
            line += '"' + value.replace(/"/g, '""') + '",';
        }
        line = line.slice(0, -1);
        str += line + '\r\n';
        for (var i = 0; i < array.length; i++) {
           var line = '';
           for (var index in array[i]) {
                var value = array[i][index] + "";
                line += '"' + value.replace(/"/g, '""') + '",';
            }
           line = line.slice(0, -1);
           str += line + '\r\n';
       }
       return str;
    }


</script>

</body></html>
